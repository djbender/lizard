<% content_for :title, "Dashboard" %>
<% content_for :header do %>
  <h1 style="display: inline-block; margin-right: 2rem;"><%= link_to "ðŸ¦Ž Lizard", root_path, class: "title-link" %></h1>
  <nav style="display: inline-block;">
    <%= link_to "Projects", projects_path %>
    <span style="margin: 0 1rem;">|</span>
    <%= link_to "Logout", logout_path, :"data-turbo" => false %>
  </nav>
<% end %>

<% @projects.each do |project| %>
  <% latest_run = latest_run_for_project(project) %>
  <article>
    <header>
      <h2><%= link_to project.name, project_path(project) %></h2>
    </header>

    <% if latest_run %>
      <p><small>Latest: <%= time_ago_in_words(latest_run.ran_at) %> ago</small></p>

      <details>
        <summary>Coverage: <strong><%= number_to_percentage(latest_run.coverage, precision: 1) %></strong></summary>
        <meter value="<%= latest_run.coverage %>" max="100"><%= latest_run.coverage %>%</meter>
      </details>

      <table>
        <tr>
          <td>Ruby Specs</td>
          <td><%= latest_run.ruby_specs %></td>
        </tr>
        <tr>
          <td>JS Specs</td>
          <td><%= latest_run.js_specs %></td>
        </tr>
        <tr>
          <td>Runtime</td>
          <td><%= latest_run.runtime.round %>s</td>
        </tr>
      </table>

      <p>
        <small>Branch: <code><%= latest_run.branch %></code></small>
      </p>
    <% else %>
      <p>No test runs yet</p>
      <p><small>API Key: <code><%= project.api_key[0..10] %>...</code></small></p>
    <% end %>

    <footer>
      <%= link_to "View Details â†’", project_path(project) %>
      <% if latest_run %>
        <small><%= run_count_for_project(project) %> runs</small>
      <% end %>
    </footer>
  </article>
<% end %>

<% if @projects.empty? %>
  <section>
    <h2>No projects yet</h2>
    <p>Create your first project to start tracking test metrics</p>
    <p><%= link_to "Create Project", new_project_path %></p>
  </section>
<% end %>

<% if @projects.any? %>
  <section>
    <h2>Recent Activity</h2>
    <table>
      <thead>
        <tr>
          <th>Project</th>
          <th>Branch</th>
          <th>Coverage</th>
          <th>Specs</th>
          <th>Runtime</th>
          <th>When</th>
        </tr>
      </thead>
      <tbody>
        <% @recent_test_runs.each do |run| %>
          <tr>
            <td><%= link_to run.project.name, project_path(run.project) %></td>
            <td><code><%= run.branch.truncate(20) %></code></td>
            <td><%= number_to_percentage(run.coverage, precision: 1) %></td>
            <td><%= run.ruby_specs + run.js_specs %></td>
            <td><%= run.runtime.round %>s</td>
            <td><%= time_ago_in_words(run.ran_at) %> ago</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </section>
<% end %>

<% content_for :footer do %>
  <section style="border-top: 1px solid #ccc; margin-top: 2rem; padding-top: 1rem;">
    <h3>Development Only</h3>
    <div style="display: flex; gap: 1rem;">
      <%= form_with url: generate_sample_data_path, method: :post, local: true do |form| %>
        <%= form.submit "Generate Sample Data", confirm: "This will create test data for the 'Test Project'. Continue?" %>
      <% end %>
      <%= form_with url: clear_sample_data_path, method: :post, local: true do |form| %>
        <%= form.submit "Clear Sample Data", confirm: "This will remove all test data for the 'Test Project'. Continue?" %>
      <% end %>
    </div>
  </section>
<% end %>

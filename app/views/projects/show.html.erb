<% content_for :title, "#{@project.name} - Test Metrics" %>

<section style="width: 100vw; margin-left: calc(-50vw + 50%); padding: 0 2rem;">
  <nav aria-label="breadcrumb">
    <%= link_to "Dashboard", root_path %> →
    <%= link_to "Projects", projects_path %> →
    <%= @project.name %>
  </nav>
</section>

<section style="width: 100vw; margin-left: calc(-50vw + 50%); margin-bottom: 2rem;">
  <canvas id="metricsChart"></canvas>
</section>

<section>
  <h1><%= @project.name %></h1>

  <div class="project-details">
    <h2>Project Details</h2>
    <table>
      <tbody>
        <tr>
          <td><strong>Name:</strong></td>
          <td><%= @project.name %></td>
        </tr>
        <tr>
          <td><strong>API Key:</strong></td>
          <td>
            <code id="api-key-display" style="cursor: pointer;" onclick="toggleApiKey()" title="Click to reveal full API key">
              <%= @project.api_key[0..10] %>...
            </code>
            <code id="api-key-full" style="display: none; cursor: pointer;" onclick="toggleApiKey()" title="Click to hide API key">
              <%= @project.api_key %>
            </code>
          </td>
        </tr>
        <tr>
          <td><strong>Created:</strong></td>
          <td><%= @project.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
        <tr>
          <td><strong>Updated:</strong></td>
          <td><%= @project.updated_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section>
  <h2>Recent Test Runs</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Branch</th>
        <th>Ruby Specs</th>
        <th>JS Specs</th>
        <th>Coverage</th>
        <th>Runtime</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @recent_runs.each do |run| %>
        <tr>
          <td><%= run.ran_at.strftime('%Y-%m-%d %H:%M') %></td>
          <td><%= run.branch %></td>
          <td><%= run.ruby_specs %></td>
          <td><%= run.js_specs %></td>
          <td><%= number_to_percentage(run.coverage, precision: 1) %></td>
          <td><%= number_with_precision(run.runtime, precision: 1) %>s</td>
          <td>
            <%= button_to "Delete", project_test_run_path(@project, run), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this test run?" } %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</section>

<%= javascript_import_module_tag "api_key_toggle" %>
<%= javascript_import_module_tag "project_metrics_chart" %>

<script type="module">
  import { initializeProjectChart } from "project_metrics_chart";

  // Initialize the metrics chart when the page loads
  document.addEventListener('DOMContentLoaded', function() {
    initializeProjectChart('<%= metrics_project_path(@project) %>');
  });
</script>

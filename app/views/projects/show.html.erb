<% content_for :title, "#{@project.name} - Test Metrics" %>

<section style="width: 100vw; margin-left: calc(-50vw + 50%); padding: 0 2rem;">
  <nav aria-label="breadcrumb">
    <%= link_to "Dashboard", root_path %> →
    <%= link_to "Projects", projects_path %> →
    <%= @project.name %>
  </nav>
</section>

<section style="width: 100vw; margin-left: calc(-50vw + 50%); margin-bottom: 2rem;">
  <canvas id="metricsChart"></canvas>
</section>

<section>
  <h1><%= @project.name %></h1>

  <div class="project-details">
    <h2>Project Details</h2>
    <table>
      <tbody>
        <tr>
          <td><strong>Name:</strong></td>
          <td><%= @project.name %></td>
        </tr>
        <tr>
          <td><strong>API Key:</strong></td>
          <td>
            <code id="api-key-display" style="cursor: pointer;" onclick="toggleApiKey()" title="Click to reveal full API key">
              <%= @project.api_key[0..10] %>...
            </code>
            <code id="api-key-full" style="display: none; cursor: pointer;" onclick="toggleApiKey()" title="Click to hide API key">
              <%= @project.api_key %>
            </code>
          </td>
        </tr>
        <tr>
          <td><strong>Created:</strong></td>
          <td><%= @project.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
        <tr>
          <td><strong>Updated:</strong></td>
          <td><%= @project.updated_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<section>
  <h2>Recent Test Runs</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Branch</th>
        <th>Ruby Specs</th>
        <th>JS Specs</th>
        <th>Coverage</th>
        <th>Runtime</th>
      </tr>
    </thead>
    <tbody>
      <% @recent_runs.each do |run| %>
        <tr>
          <td><%= run.ran_at.strftime('%Y-%m-%d %H:%M') %></td>
          <td><%= run.branch %></td>
          <td><%= run.ruby_specs %></td>
          <td><%= run.js_specs %></td>
          <td><%= number_to_percentage(run.coverage, precision: 1) %></td>
          <td><%= number_with_precision(run.runtime, precision: 1) %>s</td>
        </tr>
      <% end %>
    </tbody>
  </table>
</section>

<script>
  function toggleApiKey() {
    const truncatedElement = document.getElementById('api-key-display');
    const fullElement = document.getElementById('api-key-full');

    if (truncatedElement.style.display === 'none') {
      truncatedElement.style.display = 'inline';
      fullElement.style.display = 'none';
    } else {
      truncatedElement.style.display = 'none';
      fullElement.style.display = 'inline';
    }
  }

  fetch('<%= metrics_project_path(@project) %>')
    .then(response => response.json())
    .then(data => {
      const ctx = document.getElementById('metricsChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              min: 0,
              max: 100,
              title: {
                display: true,
                text: 'Coverage %'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Spec Count'
              },
              grid: {
                drawOnChartArea: false,
              },
            },
            y2: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Runtime (seconds)'
              },
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      });
    });
</script>
